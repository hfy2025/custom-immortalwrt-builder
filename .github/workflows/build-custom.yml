name: Build Custom ImmortalWrt

on:
  workflow_dispatch:
    inputs:
      firmware_size:
        description: '固件大小 (GB)'
        required: false
        default: '1'
        type: choice
        options:
          - '1'
          - '2'

env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential
    
    - name: Clone ImmortalWrt
      run: |
        git clone --depth=1 https://github.com/immortalwrt/immortalwrt -b openwrt-23.05 openwrt
        cd openwrt
        
        # 创建 feeds.conf.default
        cat > feeds.conf.default << 'EOF'
src-git packages https://github.com/immortalwrt/packages.git;openwrt-23.05
src-git luci https://github.com/immortalwrt/luci.git;openwrt-23.05
src-git routing https://github.com/openwrt/routing.git;openwrt-23.05
src-git telephony https://github.com/openwrt/telephony.git;openwrt-23.05
EOF
    
    - name: Update Feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
    
    - name: Configure Build
      run: |
        cd openwrt
        
        # 创建基础配置
        echo "CONFIG_TARGET_x86=y" > .config
        echo "CONFIG_TARGET_x86_64=y" >> .config
        echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> .config
        
        # 设置固件大小
        FIRMWARE_SIZE="${{ github.event.inputs.firmware_size }}"
        if [ "$FIRMWARE_SIZE" = "2" ]; then
          echo "CONFIG_TARGET_ROOTFS_PARTSIZE=2048" >> .config
        else
          echo "CONFIG_TARGET_ROOTFS_PARTSIZE=1024" >> .config
        fi
        
        # 添加基本包
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_PACKAGE_luci-ssl=y" >> .config
    
    - name: Build
      run: |
        cd openwrt
        make defconfig
        make -j2 download
        make -j2
