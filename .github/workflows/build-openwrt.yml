name: 极速构建 ImmortalWrt (Docker ImageBuilder)

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: '是否启用 SSH'
        required: false
        default: 'false'

env:
  DOCKER_IMAGE: openwrt/imagebuilder:x86-64-openwrt-25.12
  CONFIG_FILE: seed.config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: openwrt/imagebuilder:x86-64-openwrt-25.12
      options: --user root
    env:
      KERNEL_PARTSIZE: 16
      ROOTFS_PARTSIZE: 1024

    steps:
    - name: 检查本仓库
      uses: actions/checkout@v3

    - name: 初始化环境
      run: |
        echo "FILE_DATE=$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
        mkdir -p files

    - name: 执行自定义脚本 (DIY)
      run: |
        chmod +x $DIY_P1_SH $DIY_P2_SH
        ./$DIY_P1_SH
        ./$DIY_P2_SH

    - name: 极速生成固件
      id: compile
      run: |
        # 1. 自动定位 ImageBuilder 目录 (优先查找 /builder 或 /home/build 下的目录)
        if [ -d "/builder" ]; then
          IB_DIR="/builder"
        else
          IB_DIR=$(find /home/build -maxdepth 2 -name "openwrt-imagebuilder*" -type d | head -n 1)
        fi
        
        if [ -z "$IB_DIR" ]; then
          echo "错误: 未找到 ImageBuilder 目录!"
          exit 1
        fi
        
        echo "使用 ImageBuilder 目录: $IB_DIR"
        cd "$IB_DIR"
        
        # 2. 准备配置文件
        # 如果工作区有配置文件则使用，否则创建一个基础配置
        if [ -f "$GITHUB_WORKSPACE/$CONFIG_FILE" ]; then
          cp "$GITHUB_WORKSPACE/$CONFIG_FILE" .config
        else
          echo "CONFIG_TARGET_x86=y" > .config
          echo "CONFIG_TARGET_x86_64=y" >> .config
        fi
        
        # 3. 解析包列表
        # 过滤掉注释并提取软件包名
        PACKAGES=$(grep '^CONFIG_PACKAGE_' .config | grep '=y' | sed 's/CONFIG_PACKAGE_//;s/=y//' | tr '
' ' ')
        
        # 4. 执行构建
        # 注入分区大小，FILES 目录设为工作区下的 files
        make image           PACKAGES="$PACKAGES"           FILES="$GITHUB_WORKSPACE/files"           KERNEL_PARTSIZE=$KERNEL_PARTSIZE           ROOTFS_PARTSIZE=$ROOTFS_PARTSIZE
        
        # 5. 整理产物
        mkdir -p $GITHUB_WORKSPACE/bin/targets/x86/64/
        find bin/targets/x86/64/ -type f ( -name "*.img.gz" -o -name "*.iso" -o -name "*.sha256sums" ) -exec cp {} $GITHUB_WORKSPACE/bin/targets/x86/64/ ;
        
        echo "DEVICE_NAME=x86_64" >> $GITHUB_ENV

    - name: 发布到 Release
      uses: softprops/action-gh-release@v1
      if: env.UPLOAD_RELEASE == 'true'
      with:
        tag_name: ImmortalWrt_x86_64_${{ env.FILE_DATE }}
        name: ImmortalWrt 极速发布 [${{ env.FILE_DATE }}]
        body: |
          编译完成！
          构建模式: Docker ImageBuilder (极速)
          镜像版本: openwrt/imagebuilder:x86-64-openwrt-25.12
          管理地址: 192.168.6.1
          分区大小: 内核 ${{ env.KERNEL_PARTSIZE }}MB / 系统 ${{ env.ROOTFS_PARTSIZE }}MB
        files: bin/targets/*/*/*
