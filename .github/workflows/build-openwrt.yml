name: 极速构建 ImmortalWrt (Docker ImageBuilder)

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: '是否启用 SSH'
        required: false
        default: 'false'

env:
  DOCKER_IMAGE: openwrt/imagebuilder:x86-64-openwrt-25.12
  CONFIG_FILE: seed.config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: openwrt/imagebuilder:x86-64-openwrt-25.12
      options: --user root
    env:
      KERNEL_PARTSIZE: 16
      ROOTFS_PARTSIZE: 1024

    steps:
    - name: 检查本仓库
      uses: actions/checkout@v3

    - name: 初始化环境
      run: |
        echo "FILE_DATE=$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
        mkdir -p files

    - name: 执行自定义脚本 (DIY)
      run: |
        chmod +x $DIY_P1_SH $DIY_P2_SH
        ./$DIY_P1_SH
        ./$DIY_P2_SH

    - name: 极速生成固件
      id: compile
      run: |
        # 1. 自动定位包含 Makefile 的 ImageBuilder 目录
        IB_DIR=""
        [ -f "/builder/Makefile" ] && IB_DIR="/builder"
        if [ -z "$IB_DIR" ]; then
          IB_DIR=$(find /home/build -name "Makefile" -exec dirname {} ; | head -n 1)
        fi
        
        if [ -z "$IB_DIR" ]; then
          echo "错误: 在容器中找不到 Makefile，无法继续构建。"
          exit 1
        fi
        
        echo "ImageBuilder 根目录: $IB_DIR"
        cd "$IB_DIR"
        
        # 2. 准备配置文件
        if [ -f "$GITHUB_WORKSPACE/$CONFIG_FILE" ]; then
          cp "$GITHUB_WORKSPACE/$CONFIG_FILE" .config
        else
          echo "CONFIG_TARGET_x86=y" > .config
          echo "CONFIG_TARGET_x86_64=y" >> .config
        fi
        
        # 3. 提取软件包并合并为单行字符串，避免换行问题
        PACKAGES=$(grep '^CONFIG_PACKAGE_' .config | grep '=y' | sed 's/CONFIG_PACKAGE_//;s/=y//' | xargs echo)
        
        echo "即将编译的软件包列表: $PACKAGES"
        
        # 4. 执行构建 (单行命令，彻底杜绝 YAML 换行导致的空格/解析错误)
        make image PROFILE="generic" PACKAGES="$PACKAGES" FILES="$GITHUB_WORKSPACE/files" KERNEL_PARTSIZE=$KERNEL_PARTSIZE ROOTFS_PARTSIZE=$ROOTFS_PARTSIZE
        
        # 5. 整理产物并复制回 GitHub 工作目录
        mkdir -p $GITHUB_WORKSPACE/bin/targets/x86/64/
        [ -d "bin/targets" ] && find bin/targets/ -type f \( -name "*.img.gz" -o -name "*.iso" -o -name "*.sha256sums" \) -exec cp {} $GITHUB_WORKSPACE/bin/targets/x86/64/ \;
        
        echo "DEVICE_NAME=x86_64" >> $GITHUB_ENV

    - name: 发布到 Release
      uses: softprops/action-gh-release@v1
      if: env.UPLOAD_RELEASE == 'true'
      with:
        tag_name: ImmortalWrt_x86_64_${{ env.FILE_DATE }}
        name: ImmortalWrt 极速发布 [${{ env.FILE_DATE }}]
        body: |
          编译完成！
          构建模式: Docker ImageBuilder (极速)
          管理地址: 192.168.6.1
          分区设置: 16MB / 1024MB
        files: bin/targets/x86/64/*
